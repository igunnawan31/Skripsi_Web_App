generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER & BRANCH ====================
model User {
  id        String     @id @default(uuid())
  name      String
  email     String     @unique
  password  String
  majorRole MajorRole
  minorRole MinorRole?
  photo     Json?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relasi Absensi & Cuti
  absensi       Absensi[] @relation("UserAbsen")
  cutiDiajukan  Cuti[]    @relation("UserCuti")
  cutiDisetujui Cuti[]    @relation("ApproverCuti")

  // Relasi Salary & Kontrak
  salary  Salary[]       @relation("UserSalary")
  kontrak KontrakKerja[] @relation("UserKontrak")

  // Relasi Project
  projectTeams ProjectTeam[] @relation("ProjectMember")

  // Relasi KPI
  indikatorDibuat IndikatorKPI[] @relation("PembuatIndikator")
  penilaiKPI      JawabanKPI[]   @relation("JawabanEvaluator")
  dinilaiKPI      JawabanKPI[]   @relation("JawabanEvaluatee")
  rekapKPI        RekapKPI[]     @relation("RekapUserKPI")
  evaluatorOf     Evaluations[]  @relation("UserEvaluator")
  evaluateeOf     Evaluations[]  @relation("UserEvaluatee")

  // Relasi Reimburse
  requestedReimburse Reimburse[] @relation("ReimburseRequester")
  approvedReimburse  Reimburse[] @relation("ReimburseApprover")

  // Relasi Notifikasi
  notifications Notification[] @relation("UserNotification")

  @@index([email])
}

// ==================== ABSENSI & CUTI ====================
model Absensi {
  userId     String
  date       DateTime   @db.Date
  workStatus WorkStatus
  checkIn    DateTime   @default(now())
  checkOut   DateTime?
  address    String?
  latitude   String?
  longitude  String?
  photo      Json?
  createdAt  DateTime   @default(now())

  user User @relation("UserAbsen", fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, date])
  @@index([date])
  @@index([userId, date])
}

model Cuti {
  id         String     @id @default(uuid())
  userId     String
  approverId String?
  startDate  DateTime   @db.Date
  endDate    DateTime   @db.Date
  reason     String
  status     StatusCuti @default(MENUNGGU)
  catatan    String? // Catatan dari approver
  dokumen    Json?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  user     User  @relation("UserCuti", fields: [userId], references: [id], onDelete: Cascade)
  approver User? @relation("ApproverCuti", fields: [approverId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([approverId])
  @@index([status])
  @@index([startDate, endDate])
}

// ==================== GAJI & KONTRAK ====================
model KontrakKerja {
  id               String             @id @default(uuid())
  userId           String
  projectId        String?
  jenis            EmployeeType       @default(CONTRACT)
  metodePembayaran MetodePembayaran
  dpPercentage     Int?
  finalPercentage  Int?
  totalBayaran     Int // Dalam rupiah
  absensiBulanan   Int // Quota absensi per bulan
  cutiBulanan      Int // Quota cuti per bulan
  status           KontrakKerjaStatus @default(ACTIVE)
  catatan          String?
  documents        Json? // Path/URL dokumen kontrak
  startDate        DateTime           @db.Date
  endDate          DateTime?          @db.Date
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  user    User     @relation("UserKontrak", fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation("KontrakProject", fields: [projectId], references: [id], onDelete: Cascade)
  salary  Salary[] @relation("KontrakSalary")

  @@index([userId])
  @@index([projectId])
  @@index([status])
  @@index([startDate, endDate])
}

model Salary {
  id          String       @id @default(uuid())
  userId      String
  kontrakId   String?
  periode     String // Format: "YYYY-MM" contoh: "2025-01"
  dueDate     DateTime     @db.Date
  status      SalaryStatus @default(PENDING)
  amount      Int // Jumlah gaji dalam rupiah
  paymentDate DateTime?
  paychecks   Json? // Nambah Schema, ketika HR membayar dan butuh bukti pembayaran
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  user    User          @relation("UserSalary", fields: [userId], references: [id], onDelete: Cascade)
  kontrak KontrakKerja? @relation("KontrakSalary", fields: [kontrakId], references: [id], onDelete: Cascade)

  @@unique([userId, kontrakId, periode]) // Satu user hanya bisa punya 1 gaji per periode
  @@index([userId])
  @@index([kontrakId])
  @@index([status])
  @@index([dueDate])
  @@index([periode])
}

// ==================== PROJECT ====================
model Project {
  id          String        @id @default(uuid())
  name        String
  description String?
  startDate   DateTime      @db.Date
  endDate     DateTime      @db.Date
  status      ProjectStatus @default(ACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  documents   Json?

  projectTeams ProjectTeam[]  @relation("ProjectTeam")
  kontrak      KontrakKerja[] @relation("KontrakProject")
  agenda       Agenda[]       @relation("ProjectAgenda")

  @@index([name])
  @@index([status])
}

model ProjectTeam {
  projectId String
  userId    String
  joinedAt  DateTime @default(now())

  project Project @relation("ProjectTeam", fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation("ProjectMember", fields: [userId], references: [id], onDelete: Cascade)

  @@id([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

// ==================== KPI SYSTEM ====================
model IndikatorKPI {
  id           String             @id @default(uuid())
  name         String
  description  String
  category     String
  startDate    DateTime           @db.Date
  endDate      DateTime           @db.Date
  statusPublic Boolean            @default(false)
  status       StatusIndikatorKPI @default(DRAFT)
  createdById  String
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  createdBy User @relation("PembuatIndikator", fields: [createdById], references: [id], onDelete: Cascade)

  // Relasi ke pertanyaan
  pertanyaan PertanyaanKPI[] @relation("IndikatorPertanyaan")

  evaluation Evaluations[] @relation("IndikatorEvaluation")

  // Hasil penilaian
  jawaban JawabanKPI[] @relation("IndikatorJawaban")
  rekap   RekapKPI[]   @relation("IndikatorRekap")

  @@index([createdById])
  @@index([status])
  @@index([startDate, endDate])
}

model Evaluations {
  indikatorId String
  evaluatorId String
  evaluateeId String
  createdAt   DateTime @default(now())

  indikator IndikatorKPI @relation("IndikatorEvaluation", fields: [indikatorId], references: [id], onDelete: Cascade)
  evaluator User         @relation("UserEvaluator", fields: [evaluatorId], references: [id], onDelete: Cascade)
  evaluatee User         @relation("UserEvaluatee", fields: [evaluateeId], references: [id], onDelete: Cascade)

  @@id([indikatorId, evaluateeId, evaluatorId])
  @@index([indikatorId])
  @@index([evaluateeId])
  @@index([evaluatorId])
}

model PertanyaanKPI {
  id          String             @id @default(uuid())
  indikatorId String
  kategori    KategoriPertanyaan
  pertanyaan  String             @db.Text
  bobot       Float
  aktif       Boolean            @default(true)
  urutanSoal  Int                @default(0) // buat sorting
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  indikator IndikatorKPI @relation("IndikatorPertanyaan", fields: [indikatorId], references: [id], onDelete: Cascade)
  jawaban   JawabanKPI[] @relation("JawabanPertanyaan")

  @@index([indikatorId])
  @@index([aktif])
}

model JawabanKPI {
  id           String   @id @default(uuid())
  indikatorId  String
  pertanyaanId String
  evaluatorId  String
  evaluateeId  String
  nilai        Int // Nilai sesuai dengan skala (bisa "1", "2", atau "Sangat Baik", dll)
  notes        String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  indikator  IndikatorKPI  @relation("IndikatorJawaban", fields: [indikatorId], references: [id], onDelete: Cascade)
  pertanyaan PertanyaanKPI @relation("JawabanPertanyaan", fields: [pertanyaanId], references: [id], onDelete: Restrict)
  evaluator  User          @relation("JawabanEvaluator", fields: [evaluatorId], references: [id], onDelete: Cascade)
  evaluatee  User          @relation("JawabanEvaluatee", fields: [evaluateeId], references: [id], onDelete: Cascade)

  @@unique([pertanyaanId, evaluatorId, evaluateeId]) // Satu penilai hanya bisa jawab 1x per pertanyaan per dinilai
  @@index([indikatorId])
  @@index([pertanyaanId])
  @@index([evaluatorId])
  @@index([evaluateeId])
  @@index([evaluatorId, evaluateeId])
}

model RekapKPI {
  id            String   @id @default(uuid())
  indikatorId   String
  userId        String // User yang dinilai
  totalNilai    Float // Total nilai dari semua pertanyaan
  rataRata      Float // Rata-rata nilai
  jumlahPenilai Int // Berapa banyak orang yang menilai
  keterangan    String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  indikator IndikatorKPI @relation("IndikatorRekap", fields: [indikatorId], references: [id], onDelete: Cascade)
  user      User         @relation("RekapUserKPI", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([indikatorId, userId]) // Satu user hanya punya 1 rekap per indikator
  @@index([indikatorId])
  @@index([userId])
}

model Agenda {
  id          String             @id @default(cuid())
  title       String
  eventDate   DateTime
  projectId   String?
  status      AgendaStatus       @default(UPCOMING)
  frequency   AgendaFreq?
  timezone    String
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  project     Project?           @relation("ProjectAgenda", fields: [projectId], references: [id], onDelete: Cascade)
  occurrences AgendaOccurrence[] @relation("AgendaOccurrences")
}

model AgendaOccurrence {
  id          String   @id @default(cuid())
  agendaId    String
  date        DateTime
  isCancelled Boolean  @default(false)
  agenda      Agenda   @relation("AgendaOccurrences", fields: [agendaId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([agendaId, date])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  category  String
  content   String
  createdAt DateTime @default(now())
  user      User     @relation("UserNotification", fields: [userId], references: [id], onDelete: Cascade)
}

model Reimburse {
  id             String         @id @default(cuid())
  userId         String
  approverId     String?
  title          String
  totalExpenses  Int
  approvalStatus ApprovalStatus @default(PENDING)
  catatan        String?
  documents      Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  requester User  @relation("ReimburseRequester", fields: [userId], references: [id], onDelete: Cascade)
  approver  User? @relation("ReimburseApprover", fields: [approverId], references: [id], onDelete: Cascade)
}

// ==================== ENUMS ====================
enum MajorRole {
  OWNER
  KARYAWAN
}

enum MinorRole {
  HR
  ADMIN
  PROJECT_MANAGER
  UI_UX
  FRONTEND
  BACKEND
}

enum WorkStatus {
  WFH
  WFO
  HYBRID
}

enum ApprovalStatus {
  APPROVED
  PENDING
  REJECTED
}

enum StatusCuti {
  EXPIRED
  MENUNGGU
  DITERIMA
  DITOLAK
  BATAL
}

enum SalaryStatus {
  PENDING
  PAID
  OVERDUE
}

enum ProjectStatus {
  ACTIVE
  ON_HOLD
  COMPLETED
}

enum KontrakKerjaStatus {
  ACTIVE
  COMPLETED
  ON_HOLD // Kontrak sempat berhenti sementara
}

enum MetodePembayaran {
  MONTHLY // Dibayar per bulan
  TERMIN // Dibayar per termin/milestone
  FULL // Dibayar di awal (freelance)
}

enum KategoriPertanyaan {
  KINERJA // Kinerja Karyawan
  SIFAT // Sifat Karyawan
}

enum StatusIndikatorKPI {
  DRAFT // Masih draft
  ACTIVE // Sedang berjalan
  COMPLETED // Sudah selesai
  ARCHIVED // Diarsipkan
}

enum AgendaFreq {
  DAILY
  WEEKLY
  MONTHLY
}

enum AgendaStatus {
  UPCOMING
  COMPLETED
  CANCELLED
}

enum EmployeeType {
  CONTRACT
  PERMANENT
}
